<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Service Dashboard</title>
    
    <style>
        /* Your CSS styles remain exactly the same */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #FFFDF6; /* Warm Cream */
            margin: 0;
            padding: 24px;
            color: #3B2F2F; /* Rich Brown */
        }
        h1 {
            color: #B5A642; /* Olive Gold */
        }
        .kpi-section, .chart-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }
        .kpi-card, .chart-container {
            background-color: #D8CFC4; /* Taupe */
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .kpi-card h2, .chart-container h3 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #3B2F2F; /* Rich Brown */
            text-transform: uppercase;
        }
        .kpi-card p {
            margin: 0;
            font-size: 32px;
            font-weight: bold;
            color: #B5A642; /* Olive Gold */
        }
        .kpi-card:nth-child(1) { border-left: 4px solid #B5A642; }
        .kpi-card:nth-child(2) { border-left: 4px solid #B5A642; }
        .kpi-card:nth-child(3) { border-left: 4px solid #B5A642; }
        .kpi-card:nth-child(4) { border-left: 4px solid #B5A642; }
        .session-logs {
            margin-top: 24px;
        }
        #session-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }
        #session-table th, #session-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #B5A642;
            color: #3B2F2F;
        }
        #session-table th {
            color: #B5A642;
        }
        .live-status-section {
            margin-bottom: 24px;
        }
        .live-status-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }
        .live-status-card {
            background-color: #D8CFC4;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
        }
        .live-status-card h4 {
            font-size: 1.25rem;
            font-weight: bold;
            margin: 0 0 8px 0;
            color: #3B2F2F;
        }
        .live-status-card p {
            font-size: 0.875rem;
            color: #B5A642;
            margin: 0;
        }
        
        /* CSS classes to match the events */
        .live-status-card.idle { background-color: #D8CFC4; border-left: 4px solid #B5A642; }
        
        .live-status-card.called { background-color: #fef3c7; border-left: 4px solid #f59e0b; }
        .live-status-card.called h4 { color: #b45309; }
        .live-status-card.called p { color: #d97706; }
        
        /* 'attended' is used for Waiter_Responded and Food_Delivered */
        .live-status-card.attended { background-color: #e0f2fe; border-left: 4px solid #0ea5e9; }
        .live-status-card.attended h4 { color: #0369a1; }
        .live-status-card.attended p { color: #0ea5e9; }
        
        #real-time-clock {
            position: absolute;
            top: 24px;
            right: 24px;
            font-size: 1.2rem;
            font-weight: bold;
            color: #3B2F2F;
        }
    </style>
</head>
<body>
    <div id="real-time-clock"></div>
    <h1>Restaurant Service Dashboard</h1>
    
    <p>Displaying live data. Last updated: <span id="last-updated"></span></p>

    <div class="kpi-section">
        <div class="kpi-card"><h2>Total Calls</h2><p id="total-calls">0</p></div>
        <div class="kpi-card"><h2>Open Requests</h2><p id="open-requests">0</p></div>
        <div class="kpi-card"><h2>Avg Respond (min)</h2><p id="avg-respond">0.0</p></div>
        <div class="kpi-card"><h2>Avg Service (min)</h2><p id="avg-delivery">0.0</p></div>
    </div>

    <div class="chart-section">
        <div class="chart-container"><h3>Calls per Hour</h3><canvas id="calls-per-hour-chart"></canvas></div>
        <div class="chart-container"><h3>Request Status</h3><canvas id="request-status-chart"></canvas></div>
    </div>
    
    <div class="live-status-section">
        <h3>Live Table Status</h3>
        <p>Real-time monitoring of all restaurant tables</p>
        <div class="live-status-container" id="live-status-cards"></div>
    </div>

    <div class="session-logs">
        <h3>Full Event Log</h3>
        <table id="session-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Table</th>
                    <th>Event</th>
                    <th>Timestamp</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    let currentCharts = {};

    function updateClock() {
        const now = new Date();
        document.getElementById('real-time-clock').textContent = now.toLocaleTimeString('en-US');
        document.getElementById('last-updated').textContent = now.toLocaleTimeString('en-US');
    }

    /**
     * Processes raw data from the server into the format the dashboard expects.
     */
    function processDataFromRecords(records) {
        if (!records || records.length === 0) {
            // Return a default empty state if there's no data
            return {
                total_calls: 0, open_requests: 0, avg_respond: 0.0, avg_delivery: 0.0,
                calls_per_hour: Array(24).fill(0).reduce((acc, val, i) => ({...acc, [i]: val }), {}),
                request_status: { open: 0, closed: 0 },
            };
        }

        // --- Calculate KPIs and Chart Data ---
        let total_calls = 0;
        const calls_per_hour = Array(24).fill(0).reduce((acc, val, i) => ({...acc, [i]: val }), {});
        const respond_times = [];
        const delivery_times = []; // This is now service time
        
        // Group records by table to identify sessions
        const tables = {};
        records.forEach(log => {
            if (!tables[log.table_id]) tables[log.table_id] = [];
            tables[log.table_id].push({
                event: log.event,
                timestamp: new Date(log.timestamp) // Timestamps are ISO strings
            });
        });

        let closed_requests = 0;
        for (const table_id in tables) {
            const events = tables[table_id].sort((a, b) => a.timestamp - b.timestamp);
            let call_time = null;
            let attended_time = null;

            events.forEach(event => {
                // Use event names from C++ code
                if (event.event === 'Customer_Called') {
                    total_calls++;
                    calls_per_hour[event.timestamp.getHours()]++;
                    call_time = event.timestamp; // Start of a new session
                    attended_time = null; // Reset
                } else if (event.event === 'Waiter_Responded' && call_time) {
                    attended_time = event.timestamp;
                    const diff_ms = attended_time.getTime() - call_time.getTime();
                    respond_times.push(diff_ms / (1000 * 60)); // in minutes
                
                // *** FIX: Changed 'Table_Closed ðŸ’° Bill' to 'Food_Delivered' ***
                // This event now closes the request cycle for KPI purposes.
                } else if (event.event === 'Food_Delivered' && call_time) { 
                    closed_requests++;
                    const diff_ms = event.timestamp.getTime() - call_time.getTime();
                    delivery_times.push(diff_ms / (1000 * 60)); // in minutes
                    
                    // Reset session
                    call_time = null;
                    attended_time = null;
                }
            });
        }
        
        const open_requests = total_calls - closed_requests;
        const avg_respond = respond_times.length > 0 ? (respond_times.reduce((a, b) => a + b, 0) / respond_times.length) : 0;
        const avg_delivery = delivery_times.length > 0 ? (delivery_times.reduce((a, b) => a + b, 0) / delivery_times.length) : 0;

        return {
            total_calls: total_calls,
            open_requests: open_requests,
            avg_respond: avg_respond.toFixed(2),
            avg_delivery: avg_delivery.toFixed(2),
            calls_per_hour: calls_per_hour,
            request_status: { open: open_requests, closed: closed_requests },
        };
    }
    
    // Helper function to get CSS class from event name
    function getStatusClass(event) {
        if (event === 'Customer_Called') return 'called';
        // 'attended' class applies to both response and delivery
        if (event === 'Waiter_Responded' || event === 'Food_Delivered') return 'attended';
        // All other states (or undefined) are 'idle'
        return 'idle';
    }

    function drawDashboard(processedData, rawData) {
        // Update KPIs
        document.getElementById('total-calls').textContent = processedData.total_calls;
        document.getElementById('open-requests').textContent = processedData.open_requests;
        document.getElementById('avg-respond').textContent = processedData.avg_respond;
        document.getElementById('avg-delivery').textContent = processedData.avg_delivery;
        
        // Destroy old charts before drawing new ones
        Object.values(currentCharts).forEach(chart => chart.destroy());
        currentCharts = {};

        // ---- Calls Per Hour Chart ----
        const callsPerHourCtx = document.getElementById('calls-per-hour-chart').getContext('2d');
        currentCharts.callsPerHour = new Chart(callsPerHourCtx, {
            type: 'line',
            data: {
                labels: Object.keys(processedData.calls_per_hour),
                datasets: [{
                    label: 'Calls', data: Object.values(processedData.calls_per_hour),
                    borderColor: '#B5A642', backgroundColor: 'rgba(181, 166, 66, 0.2)',
                    fill: true, tension: 0.4
                }]
            }
        });

        // ---- Request Status Pie Chart ----
        const requestStatusCtx = document.getElementById('request-status-chart').getContext('2d');
        currentCharts.requestStatus = new Chart(requestStatusCtx, {
            type: 'pie',
            data: {
                labels: [
                    `Open (${processedData.request_status.open})`, 
                    `Closed (${processedData.request_status.closed})`
                ],
                datasets: [{
                    data: [processedData.request_status.open, processedData.request_status.closed],
                    backgroundColor: ['#F6B84F', '#B5A642'] // Open: Yellow, Closed: Olive
                }]
            }
        });

        // --- Live Status Cards (uses live_status from server) ---
        const liveStatusContainer = document.getElementById('live-status-cards');
        liveStatusContainer.innerHTML = ''; // Clear old cards
        
        // Check if rawData.live_status exists and has items
        if (rawData.live_status && rawData.live_status.length > 0) {
            // Sort by table_id for a consistent view
            rawData.live_status.sort((a, b) => a.table_id - b.table_id);
            
            rawData.live_status.forEach(status => {
                const card = document.createElement('div');
                
                // *** FIX: Use 'status.last_event' not 'status.event' ***
                const statusClass = getStatusClass(status.last_event);
                
                card.className = `live-status-card ${statusClass}`;
                
                // Clean up event text for display
                // *** FIX: Use 'status.last_event' not 'status.event' ***
                const displayText = status.last_event.replace('_', ' ').split('ðŸ’°')[0].trim();
                
                card.innerHTML = `<h4>Table ${status.table_id}</h4><p>${displayText}</p><p>${status.minutes_ago}m ago</p>`;
                
                liveStatusContainer.appendChild(card);
            });
        } else {
            liveStatusContainer.innerHTML = '<p>No active tables.</p>';
        }
        
        // ---- Session Logs Table (uses raw records from server) ----
        const tableBody = document.querySelector('#session-table tbody');
        tableBody.innerHTML = '';
        
        // Check if rawData.records exists
        if (rawData.records && rawData.records.length > 0) {
            // Server already sorts by timestamp, no need to re-sort
            rawData.records.forEach(log => { 
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${log.id}</td>
                    <td>${log.table_id}</td>
                    <td>${log.event}</td>
                    <td>${new Date(log.timestamp).toLocaleString()}</td>`;
                tableBody.appendChild(row);
            });
        } else {
            tableBody.innerHTML = '<tr><td colspan="4">No events logged yet.</td></tr>';
        }
    }

    function fetchData() {
        fetch('/data')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // data is now { records: [...], live_status: [...] }
                const processedData = processDataFromRecords(data.records);
                drawDashboard(processedData, data);
                updateClock(); // Update clock after successful fetch
            })
            .catch(error => {
                console.error('Error fetching data:', error);
                document.getElementById('live-status-cards').innerHTML = '<p style="color: red;">Error loading dashboard data.</p>';
            });
    }

    document.addEventListener('DOMContentLoaded', () => {
        fetchData(); // Fetch initial data on page load
        setInterval(fetchData, 5000); // Refresh data every 5 seconds
    });
    </script>
</body>
</html>
